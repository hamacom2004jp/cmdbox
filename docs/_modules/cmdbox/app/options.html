

<!DOCTYPE html>
<html class="writer-html5" lang="jp" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cmdbox.app.options &mdash; cmdbox 2025/11/30 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=3fafac33" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=568024d5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            cmdbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/command.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/audit.html">Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/tts.html">Text-to-Speech (TTS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer.html">Developer Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/errors.html">Common Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cmdbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cmdbox.app.options</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cmdbox.app.options</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cmdbox.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">common</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">web</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cmdbox.app.commons</span><span class="w"> </span><span class="kn">import</span> <span class="n">module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">WebSocket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.routing</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRoute</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.routing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Route</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>


<div class="viewcode-block" id="Options">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">:</span>
    <span class="n">T_INT</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
    <span class="n">T_FLOAT</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
    <span class="n">T_BOOL</span> <span class="o">=</span> <span class="s1">&#39;bool&#39;</span>
    <span class="n">T_STR</span> <span class="o">=</span> <span class="s1">&#39;str&#39;</span>
    <span class="n">T_DATE</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">T_DATETIME</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span>
    <span class="n">T_DICT</span> <span class="o">=</span> <span class="s1">&#39;dict&#39;</span>
    <span class="n">T_TEXT</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
    <span class="n">T_FILE</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
    <span class="n">T_DIR</span> <span class="o">=</span> <span class="s1">&#39;dir&#39;</span>
    <span class="n">T_PASSWD</span> <span class="o">=</span> <span class="s1">&#39;passwd&#39;</span>
    <span class="n">T_MLIST</span> <span class="o">=</span> <span class="s1">&#39;mlist&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;T_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot set attribute. (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">_instance</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Options.getInstance">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.getInstance">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">(</span><span class="n">appcls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Options</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Options</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">appcls</span><span class="o">=</span><span class="n">appcls</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="n">ver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Options</span><span class="o">.</span><span class="n">_instance</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appcls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appcls</span> <span class="o">=</span> <span class="n">appcls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_logger</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">default_logger</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="p">,</span> <span class="n">webcall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_loaded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_cli</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_web</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agentrule_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_options</span><span class="p">()</span>

<div class="viewcode-block" id="Options.get_mode_keys">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_mode_keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mode_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.get_modes">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        起動モードの選択肢を取得します。</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, str]]: 起動モードの選択肢</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.get_cmd_keys">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_cmd_keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cmd_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.get_cmds">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_cmds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        コマンドの選択肢を取得します。</span>
<span class="sd">        Args:</span>
<span class="sd">            mode: 起動モード</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, str]]: コマンドの選択肢</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Please select mode.&#39;</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Please select mode.&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.get_cmd_attr">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_cmd_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cmd_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        コマンドの属性を取得します。</span>
<span class="sd">        Args:</span>
<span class="sd">            mode: 起動モード</span>
<span class="sd">            cmd: コマンド</span>
<span class="sd">            attr: 属性</span>
<span class="sd">        Returns:</span>
<span class="sd">            Any: 属性の値</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Unknown mode. (</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">cmd</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">cmd</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="Options.get_svcmd_feature">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_svcmd_feature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_svcmd_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">svcmd</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        サーバー側のコマンドのフューチャーを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            svcmd: サーバー側のコマンド</span>
<span class="sd">        Returns:</span>
<span class="sd">            feature.Feature: フューチャー</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">svcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">svcmd</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">svcmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;svcmd&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;svcmd&quot;</span><span class="p">][</span><span class="n">svcmd</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.get_cmd_choices">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_cmd_choices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cmd_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">webmode</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        コマンドのオプション一覧を取得します。</span>
<span class="sd">        Args:</span>
<span class="sd">            mode: 起動モード</span>
<span class="sd">            cmd: コマンド</span>
<span class="sd">            webmode (bool, optional): Webモードからの呼び出し. Defaults to False</span>
<span class="sd">            opt (Dict[str, Any], optional): オプション値. Defaults to {}</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: オプションの選択肢</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_attr</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;choice_fn&#39;</span> <span class="ow">in</span> <span class="n">o</span> <span class="ow">and</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;choice_fn&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;choice_fn&#39;</span><span class="p">](</span><span class="n">o</span><span class="p">,</span> <span class="n">webmode</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">webmode</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;web&#39;</span> <span class="ow">in</span> <span class="n">o</span> <span class="ow">and</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;********&#39;</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Options.get_cmd_opt">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.get_cmd_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cmd_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">webmode</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        コマンドのオプションを取得します。</span>
<span class="sd">        Args:</span>
<span class="sd">            mode: 起動モード</span>
<span class="sd">            cmd: コマンド</span>
<span class="sd">            opt: オプション</span>
<span class="sd">            webmode (bool, optional): Webモードからの呼び出し. Defaults to False</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: オプションの値</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_choices</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">webmode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">o</span> <span class="ow">and</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">o</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Options.list_options">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.list_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_list</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_INT</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;append&#39;</span> <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;multi&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_FLOAT</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;append&#39;</span> <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;multi&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_DICT</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;multi&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;list_options: The multi must be True if type is dict. key=</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">, val=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;append&#39;</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_MLIST</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;append&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;append&#39;</span> <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;multi&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;-</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;short&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">o</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;description_en&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">common</span><span class="o">.</span><span class="n">is_japan</span><span class="p">()</span> <span class="k">else</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;description_ja&#39;</span><span class="p">]</span>
            <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;multi&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;list_options: The default value must be None if multi is True. key=</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">, val=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;opts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_list</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1">#for mode in self._options[&quot;mode&quot;][&#39;choice&#39;]:</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">_list</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Options.mk_opt_list">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.mk_opt_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mk_opt_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">webmode</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">opt_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_choices</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">],</span> <span class="n">webmode</span><span class="p">)</span>
        <span class="n">opt_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]]</span>
        <span class="n">file_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stdout_log&#39;</span><span class="p">,</span> <span class="s1">&#39;capture_stdout&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">opt_schema</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;fileio&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fileio&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">file_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">opt_list</span><span class="p">,</span> <span class="n">file_dict</span></div>


<div class="viewcode-block" id="Options.init_options">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.init_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;バージョン表示&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Display version&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;useopt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_STR</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;オプションを保存しているファイルを使用します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Use the file that saves the options.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;saveopt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;指定しているオプションを `-u` で指定したファイルに保存します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Save the specified options to the file specified by `-u`.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;デバックモードで起動します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Starts in debug mode.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;debug_attach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;debug_attach&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;デバックプロセスへのアタッチを有効にするかどうかを指定します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specify whether to enable attaching to the debug process.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;debug_attach_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;debug_attach_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_INT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5678</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;デバックプロセスにアタッチするポート番号を指定します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specify the port number to attach to the debug process.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;処理結果を見やすい形式で出力します。指定しない場合json形式で出力します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Output the processing result in an easy-to-read format. If not specified, output in json format.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_STR</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;起動モードを指定します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specify the startup mode.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_STR</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;コマンドを指定します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specify the command.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_STR</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;このコマンドのタグを指定します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specify the tag for this command.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;clmsg_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_STR</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;クライアントのメッセージIDを指定します。省略した場合はuuid4で生成されます。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specifies the message ID of the client. If omitted, uuid4 will be generated.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_TEXT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;このコマンド登録の説明文を指定します。Agentがこのコマンドの用途を理解するのに使用します。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Specifies a description of this command registration, used to help the Agent understand the use of this command.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;logsv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">description_ja</span><span class="o">=</span><span class="s2">&quot;logsvを有効にします。logsvは複数のプロセスがログファイルへの書き込みを同期するための機能です。すでにlogsvが有効なプロセスがある場合は無視されます。&quot;</span><span class="p">,</span>
            <span class="n">description_en</span><span class="o">=</span><span class="s2">&quot;Enables logsv. Logsv is a feature that synchronizes log file writing among multiple processes. If there is already an active process with logsv enabled, it will be ignored.&quot;</span><span class="p">,</span>
            <span class="n">choice</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span></div>


<div class="viewcode-block" id="Options.init_debugoption">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.init_debugoption">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_debugoption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># デバックオプションを追加</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">][</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;debug&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">][</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;clmsg_id&quot;</span><span class="p">][</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;clmsg_id&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">][</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mode</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="k">if</span> <span class="s2">&quot;debug&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]]:</span>
                    <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;tag&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]]:</span>
                    <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;clmsg_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]]:</span>
                    <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;clmsg_id&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]]:</span>
                    <span class="n">c</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">mode</span><span class="p">]</span></div>


<div class="viewcode-block" id="Options.load_svcmd">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_svcmd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_svcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;cmdbox_&quot;</span><span class="p">,</span> <span class="n">excludes</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="p">[],</span> <span class="n">appcls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isloaded</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたパッケージの指定された接頭語を持つモジュールを読み込みます。</span>

<span class="sd">        Args:</span>
<span class="sd">            package_name (str): パッケージ名</span>
<span class="sd">            prefix (str): 接頭語</span>
<span class="sd">            excludes (list): 除外するモジュール名のリスト</span>
<span class="sd">            appcls (Any): アプリケーションクラス</span>
<span class="sd">            ver (Any): バージョンモジュール</span>
<span class="sd">            logger (logging.Logger): ロガー</span>
<span class="sd">            isloaded (bool): 読み込み済みかどうか</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;svcmd&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;svcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">load_features</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">excludes</span><span class="p">,</span> <span class="n">appcls</span><span class="o">=</span><span class="n">appcls</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="n">ver</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
                <span class="n">fobj</span><span class="p">:</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isloaded</span> <span class="ow">and</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loaded features: mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">, cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">fobj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">svcmd</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">get_svcmd</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">svcmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;svcmd&quot;</span><span class="p">][</span><span class="n">svcmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">fobj</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;use_agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_agentrule</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_debugoption</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="Options.is_features_loaded">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.is_features_loaded">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_features_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたフィーチャータイプが読み込まれているかどうかを返します。</span>

<span class="sd">        Args:</span>
<span class="sd">            ftype (str): フィーチャータイプ</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: 読み込まれているかどうか</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_loaded</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_loaded</span><span class="p">[</span><span class="n">ftype</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_features_yml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># cmdboxを拡張したアプリをカスタマイズするときのfeatures.ymlを読み込む</span>
        <span class="n">features_yml</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">ver</span><span class="o">.</span><span class="n">__appid__</span><span class="si">}</span><span class="s1">/features.yml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">features_yml</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">features_yml</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># cmdboxを拡張したアプリの組み込みfeatures.ymlを読み込む</span>
            <span class="n">features_yml</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ver</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;extensions&#39;</span> <span class="o">/</span> <span class="s1">&#39;features.yml&#39;</span>
        <span class="c1">#if not features_yml.exists() or not features_yml.is_file():</span>
        <span class="c1">#    features_yml = Path(&#39;.samples/features.yml&#39;)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load features.yml: </span><span class="si">{</span><span class="n">features_yml</span><span class="si">}</span><span class="s2">, is_file=</span><span class="si">{</span><span class="n">features_yml</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features_yml</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">features_yml</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span> <span class="o">=</span> <span class="n">yml</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">load_yml</span><span class="p">(</span><span class="n">features_yml</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features.yml data: </span><span class="si">{</span><span class="n">yml</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
            <span class="k">return</span> <span class="n">yml</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Options.load_features_file">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">appcls</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        フィーチャーファイル（features.yml）を読み込みます。</span>

<span class="sd">        Args:</span>
<span class="sd">            ftype (str): フィーチャータイプ。cli又はweb</span>
<span class="sd">            func (Any): フィーチャーの処理関数</span>
<span class="sd">            appcls (Any): アプリケーションクラス</span>
<span class="sd">            ver (Any): バージョンモジュール</span>
<span class="sd">            logger (logging.Logger): ロガー</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 読込み済みかどうかの判定</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_features_loaded</span><span class="p">(</span><span class="n">ftype</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_features_yml</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;features&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The root element must be &quot;features&quot;.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (There is no “</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1">” in the “features” element.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="n">ftype</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yml</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="n">ftype</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “features.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1"> element must be a list. </span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">yml</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">][</span><span class="n">ftype</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="n">ftype</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “features.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1">” element must be a list element must be a dictionary. data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;package&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “package” element must be in the dictionary of the list element of the “features.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1">” element. data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The prefix element must be in the dictionary of the list element of the “features.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s1">” element. data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">exclude_modules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;exclude_modules&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exclude_modules&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “exclude_modules” element must be a list element. data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">exclude_modules</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exclude_modules&#39;</span><span class="p">]</span>
            <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">exclude_modules</span><span class="p">,</span> <span class="n">appcls</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_features_loaded</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_loaded</span><span class="p">[</span><span class="n">ftype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="Options.load_features_args">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_args">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;args&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span> <span class="ow">or</span> <span class="s1">&#39;cli&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_options</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;opts&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;cli&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “args.cli” element must be a list element must be a dictionary. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;rule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “rule” element must be in the dictionary of the list element of the “args.cli” element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span> <span class="ow">and</span> <span class="s1">&#39;coercion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The “default” or “coercion” element must be in the dictionary of the list element of the “args.cli” element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">rk</span> <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">rk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args_dict</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="n">rk</span><span class="p">]</span> <span class="o">!=</span> <span class="n">args_dict</span><span class="p">[</span><span class="n">rk</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">rule</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">dk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args_dict</span> <span class="ow">or</span> <span class="n">args_dict</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="n">args_dict</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dv</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">args_dict</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;coercion&#39;</span> <span class="ow">in</span> <span class="n">rule</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;coercion&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;coercion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">args_dict</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ck</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cv</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args_dict</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cv</span><span class="p">)</span></div>


<div class="viewcode-block" id="Options.load_features_aliases_cli">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_aliases_cli">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_aliases_cli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_cli</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;aliases&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span> <span class="ow">or</span> <span class="s1">&#39;cli&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="n">opt_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">][</span><span class="s1">&#39;cli&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.cli” element must be a list element must be a dictionary. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The source element must be in the dictionary of the list element of the aliases.cli” element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The target element must be in the dictionary of the list element of the aliases.cli” element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip cli rule in features.yml. (The source or target element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.cli.source” element must be a dictionary element must. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.cli.target element must be a dictionary element must. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.cli.source element must have &quot;mode&quot; and &quot;cmd&quot; specified. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.cli.target element must have &quot;mode&quot; and &quot;cmd&quot; specified. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip cli rule in features.yml. (The source mode or cmd element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip cli rule in features.yml. (The target mode or cmd element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tgt_move</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;move&#39;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">reg_src_cmd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">mk</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">opt_cmd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">mk</span> <span class="o">!=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">src_mode</span> <span class="o">=</span> <span class="n">mk</span>
                <span class="n">tgt_mode</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">tgt_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">tgt_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">]</span>
                <span class="n">find</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">mv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">ck_match</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span> <span class="o">=</span> <span class="n">reg_src_cmd</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ck_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">find</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">src_cmd</span> <span class="o">=</span> <span class="n">ck</span>
                    <span class="n">tgt_cmd</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">ck_match</span><span class="o">.</span><span class="n">string</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">ck_match</span><span class="o">.</span><span class="n">groups</span><span class="p">())))</span>
                    <span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">cv</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tgt_cmd</span>
                    <span class="c1"># cmd/[target mode]/[target cmd]に追加</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">][</span><span class="n">tgt_cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
                    <span class="c1"># mode/[target mode]/[target cmd]に追加</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">tgt_mode</span><span class="p">][</span><span class="n">tgt_cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
                    <span class="c1"># mode/choiceにtarget modeがない場合は追加</span>
                    <span class="n">found_mode_choice</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">me</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tgt_mode</span><span class="p">:</span>
                            <span class="n">me</span><span class="p">[</span><span class="n">tgt_cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">found_mode_choice</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># 移動の場合は元を削除</span>
                        <span class="k">if</span> <span class="n">tgt_move</span> <span class="ow">and</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">src_mode</span> <span class="ow">and</span> <span class="n">src_cmd</span> <span class="ow">in</span> <span class="n">me</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">me</span><span class="p">[</span><span class="n">src_cmd</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_mode_choice</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;opt&#39;</span><span class="p">:</span><span class="n">tgt_mode</span><span class="p">,</span> <span class="n">tgt_cmd</span><span class="p">:</span><span class="n">cv</span><span class="p">})</span>
                    <span class="c1"># cmd/choiceにtarget cmdがない場合は追加</span>
                    <span class="n">found_cmd_choice</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ce</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tgt_cmd</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
                            <span class="n">found_cmd_choice</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># 移動の場合は元を削除(この処理をするとモード違いの同名コマンドが使えなくなるのでコメントアウト)</span>
                        <span class="c1">#if tgt_move and ce[&#39;opt&#39;] == src_cmd:</span>
                        <span class="c1">#    self._options[&quot;cmd&quot;][&quot;choice&quot;].remove(ce)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_cmd_choice</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
                    <span class="c1"># 移動の場合は元を削除</span>
                    <span class="k">if</span> <span class="n">tgt_move</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;move command: src=(</span><span class="si">{</span><span class="n">src_mode</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">src_cmd</span><span class="si">}</span><span class="s1">) -&gt; tgt=(</span><span class="si">{</span><span class="n">tgt_mode</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">tgt_cmd</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">src_cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">]:</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">][</span><span class="n">src_cmd</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;copy command: src=(</span><span class="si">{</span><span class="n">src_mode</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">src_cmd</span><span class="si">}</span><span class="s1">) -&gt; tgt=(</span><span class="si">{</span><span class="n">tgt_mode</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">tgt_cmd</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">find</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip cli rule in features.yml. (Command matching the rule not found. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">][</span><span class="n">src_mode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_cli</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Options.load_features_aliases_web">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_aliases_web">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_aliases_web</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routes</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Route</span><span class="p">],</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_web</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">routes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;routes is invalid. (The routes must be a list element.) routes=</span><span class="si">{</span><span class="n">routes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;aliases&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span> <span class="ow">or</span> <span class="s1">&#39;web&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">][</span><span class="s1">&#39;web&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.web element must be a list element must be a dictionary. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The source element must be in the dictionary of the list element of the aliases.web element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The target element must be in the dictionary of the list element of the aliases.web element. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip web rule in features.yml. (The source or target element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.web.source” element must be a dictionary element must. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.web.target element must be a dictionary element must. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.web.source element must have &quot;path&quot; specified. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;features.yml is invalid. (The aliases.web.target element must have &quot;path&quot; specified. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip web rule in features.yml. (The source path element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip web rule in features.yml. (The target path element is None. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tgt_move</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;move&#39;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">reg_src_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
            <span class="n">find</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">APIRoute</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">route_path</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">path</span>
                <span class="n">path_match</span><span class="p">:</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span> <span class="o">=</span> <span class="n">reg_src_path</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">route_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">find</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">tgt_Path</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">path_match</span><span class="o">.</span><span class="n">string</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">path_match</span><span class="o">.</span><span class="n">groups</span><span class="p">())))</span>
                <span class="n">tgt_route</span> <span class="o">=</span> <span class="n">APIRoute</span><span class="p">(</span><span class="n">tgt_Path</span><span class="p">,</span> <span class="n">route</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">route</span><span class="o">.</span><span class="n">methods</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">route</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">include_in_schema</span><span class="o">=</span><span class="n">route</span><span class="o">.</span><span class="n">include_in_schema</span><span class="p">)</span>
                <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_route</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tgt_move</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;move route: src=(</span><span class="si">{</span><span class="n">route_path</span><span class="si">}</span><span class="s1">) -&gt; tgt=(</span><span class="si">{</span><span class="n">tgt_Path</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">routes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;copy route: src=(</span><span class="si">{</span><span class="n">route_path</span><span class="si">}</span><span class="s1">) -&gt; tgt=(</span><span class="si">{</span><span class="n">tgt_Path</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">find</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skip web rule in features.yml. (Command matching the rule not found. rule=</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases_loaded_web</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Options.load_features_audit">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_audit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_audit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_loaded</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;audit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;enabled&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit element must have &quot;enabled&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span> <span class="k">return</span>
        <span class="c1"># フューチャーのoptions</span>
        <span class="k">if</span> <span class="s1">&#39;options&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit element must have &quot;options&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_write_args</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_search_args</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># writeフューチャー</span>
        <span class="k">if</span> <span class="s1">&#39;write&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit element must have &quot;write&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;write&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit.write element must have &quot;mode&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;write&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;write&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit.write element must have &quot;cmd&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;write&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_write</span><span class="p">:</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_attr</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_write_args</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_write_args</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="c1"># searchフューチャー</span>
        <span class="k">if</span> <span class="s1">&#39;search&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit element must have &quot;search&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;search&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit.search element must have &quot;mode&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;search&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;search&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The audit.search element must have &quot;cmd&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;search&#39;</span><span class="p">][</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_search</span><span class="p">:</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_attr</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_search_args</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_search_args</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_loaded</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Options.load_features_agentrule">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.load_features_agentrule">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_features_agentrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agentrule_loaded</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;agentrule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;policy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The agentrule element must have &quot;policy&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">][</span><span class="s1">&#39;policy&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;deny&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The policy element must specify allow or deny.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rules&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The agentrule element must have &quot;rules&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">][</span><span class="s1">&#39;rules&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;cmds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;cmds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;cmds&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (When “cmds” is specified, “mode” must be specified.)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;rule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;features.yml is invalid. (The agentrule.rules element must have &quot;rule&quot; specified.)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agentrule_loaded</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Options.check_agentrule">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.check_agentrule">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_agentrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        エージェントが使用してよいコマンドかどうかをチェックします</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (str): モード</span>
<span class="sd">            cmd (str): コマンド</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: 認可されたかどうか</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agentrule_loaded</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># コマンドチェック</span>
        <span class="n">jadge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">][</span><span class="s1">&#39;policy&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span><span class="p">[</span><span class="s1">&#39;agentrule&#39;</span><span class="p">][</span><span class="s1">&#39;rules&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;cmds&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">jadge</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;agent rule: mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">, cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">jadge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jadge</span> <span class="o">==</span> <span class="s1">&#39;allow&#39;</span></div>


    <span class="n">AT_USER</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
    <span class="n">AT_ADMIN</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
    <span class="n">AT_SYSTEM</span> <span class="o">=</span> <span class="s1">&#39;system&#39;</span>
    <span class="n">AT_AUTH</span> <span class="o">=</span> <span class="s1">&#39;auth&#39;</span>
    <span class="n">AT_EVENT</span> <span class="o">=</span> <span class="s1">&#39;event&#39;</span>
    <span class="n">AUDITS</span> <span class="o">=</span> <span class="p">[</span><span class="n">AT_USER</span><span class="p">,</span> <span class="n">AT_ADMIN</span><span class="p">,</span> <span class="n">AT_SYSTEM</span><span class="p">,</span> <span class="n">AT_AUTH</span><span class="p">,</span> <span class="n">AT_EVENT</span><span class="p">]</span>

<div class="viewcode-block" id="Options.audit">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.audit">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">audit</span><span class="p">(</span><span class="n">body</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audit_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        監査ログを書き込む関数を返します。</span>
<span class="sd">        デコレーターとして使用することができます。</span>

<span class="sd">        Args:</span>
<span class="sd">            body (Dict[str, Any]): 監査ログの内容</span>
<span class="sd">            audit_type (str): 監査の種類</span>
<span class="sd">            tags (List[str]): メッセージのタグ</span>
<span class="sd">            src (str): メッセージの発生源</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: レスポンスコード</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;body is invalid. (The body must be a dictionary element.)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audit_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">audit_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Options</span><span class="o">.</span><span class="n">AUDITS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;audit_type is invalid. (The audit_type must be one of the following: </span><span class="si">{</span><span class="n">Options</span><span class="o">.</span><span class="n">AUDITS</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;clmsg_tags is invalid. (The clmsg_tags must be a list element.)&#39;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_audit_write</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audit_exec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">audit_type</span><span class="o">=</span><span class="n">audit_type</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="k">return</span> <span class="n">_wrapper</span>
        <span class="k">return</span> <span class="n">_audit_write</span></div>


<div class="viewcode-block" id="Options.audit_exec">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.options.Options.audit_exec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">audit_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audit_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        監査ログを書き込みます。</span>

<span class="sd">        Args:</span>
<span class="sd">            args (Any): 呼び出し元で使用している引数</span>
<span class="sd">            body (Dict[str, Any]): 監査ログの内容</span>
<span class="sd">            audit_type (str): 監査の種類</span>
<span class="sd">            tags (List[str]): メッセージのタグ</span>
<span class="sd">            src (str): メッセージの発生源</span>
<span class="sd">            title (str): メッセージのタイトル</span>
<span class="sd">            user (str): メッセージを発生させたユーザー名</span>
<span class="sd">            kwargs (Any): 呼び出し元で使用しているキーワード引数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;audit_write_args&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_write_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">yml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_yml_data</span>
        <span class="k">if</span> <span class="n">yml</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;audit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span> <span class="ow">or</span> <span class="s1">&#39;enabled&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;audit&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;audit_write&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_write</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;audit write feature is not found.&#39;</span><span class="p">)</span>
        <span class="n">clmsg_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">get_tzoffset_str</span><span class="p">()</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_write_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audit_type</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clmsg_date</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_src&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;clmsg_src&#39;</span> <span class="ow">in</span> <span class="n">opt</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_title&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;clmsg_title&#39;</span> <span class="ow">in</span> <span class="n">opt</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;output_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_json&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;output_json&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;output_json_append&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_json_append&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;output_json_append&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6379</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;server&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;svname&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svname&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;retry_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;retry_count&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;retry_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_interval&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;retry_interval&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_enabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_enabled&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_enabled&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_host&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_host&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5432</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_port&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_port&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_user&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_user&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_password&#39;</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_dbname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;audit&#39;</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pg_dbname&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;pg_dbname&#39;</span><span class="p">]</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_logger</span>
        <span class="n">clmsg_body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">func_feature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">audited_by</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">mode</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">cmd</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;cmd&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">opt_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_choices</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stdout_log&#39;</span><span class="p">,</span> <span class="s1">&#39;capture_stdout&#39;</span><span class="p">]:</span>
                            <span class="k">continue</span>
                        <span class="n">schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">opt_schema</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;web&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;web&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
                            <span class="n">clmsg_body</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;********&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clmsg_body</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                        <span class="n">opt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;redis_host&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_host</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;redis_port&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_port</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;redis_password&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_password</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;svname&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">svname</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;clmsg_id&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">clmsg_id</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;client_only&#39;</span><span class="p">):</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;client_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">client_only</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">web</span><span class="o">.</span><span class="n">Web</span><span class="p">):</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_host</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_port</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redis_password</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">svname</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;client_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">client_only</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">Feature</span><span class="p">):</span>
                <span class="n">func_feature</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_feature</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Request</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">WebSocket</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;signin&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">]:</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">AT_ADMIN</span> <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">Options</span><span class="o">.</span><span class="n">AT_USER</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">][</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;clmsg_id&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span>
                    <span class="n">arg</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;signin&#39;</span><span class="p">][</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_id&#39;</span><span class="p">]</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clmsg_body</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;audit_type&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">Options</span><span class="o">.</span><span class="n">AT_EVENT</span>
        <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;clmsg_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">audit_write_args</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">common</span><span class="o">.</span><span class="n">chopdq</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">if</span> <span class="n">func_feature</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">func_feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">func_feature</span><span class="o">.</span><span class="n">audited_by</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">audit_write_args</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_write</span><span class="o">.</span><span class="n">apprun</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">audit_write_args</span><span class="p">,</span> <span class="n">tm</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pf</span><span class="o">=</span><span class="p">[])</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) 2023-2025 hamacom2004jp All Rights Reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>