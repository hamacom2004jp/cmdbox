

<!DOCTYPE html>
<html class="writer-html5" lang="jp" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cmdbox.app.edge &mdash; cmdbox 2025/05/28 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=3fafac33" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=a7b408b0"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            cmdbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/command.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer.html">Developer Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/errors.html">Common Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cmdbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cmdbox.app.edge</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cmdbox.app.edge</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cmdbox.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">common</span><span class="p">,</span> <span class="n">edge_tool</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">web</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cmdbox.app.commons</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cmdbox.app.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">Options</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uvicorn.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">locale</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib3</span>


<div class="viewcode-block" id="Edge">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Edge</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">appcls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appcls</span> <span class="o">=</span> <span class="n">appcls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span> <span class="o">=</span> <span class="n">edge_tool</span><span class="o">.</span><span class="n">Tool</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">appcls</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ver is None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">appcls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;appcls is None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;logger is None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data is None&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Edge.configure">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.configure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">edge_cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">tm</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">pf</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span><span class="o">=</span><span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        端末モードの設定を行います</span>

<span class="sd">        Args:</span>
<span class="sd">            edge_mode (str): edgeモード</span>
<span class="sd">            edge_cmd (str): edgeコマンド</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, str]: メッセージ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="o">.</span><span class="n">__logo__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="o">.</span><span class="n">__description__</span>
        <span class="n">common</span><span class="o">.</span><span class="n">print_format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pf</span><span class="o">=</span><span class="n">pf</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">questionary</span>
        <span class="n">ref_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get_cmd_choices</span><span class="p">(</span><span class="n">edge_mode</span><span class="p">,</span> <span class="n">edge_cmd</span><span class="p">)</span>
        <span class="n">language</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getlocale</span><span class="p">()</span>
        <span class="n">edge_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.edge&#39;</span>
        <span class="n">common</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">(</span><span class="n">edge_dir</span><span class="p">)</span>
        <span class="n">conf_file</span> <span class="o">=</span> <span class="n">edge_dir</span> <span class="o">/</span> <span class="s1">&#39;edge.conf&#39;</span>
        <span class="k">if</span> <span class="n">conf_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># 設定ファイルが存在する場合は読み込む</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">loadopt</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">skip_opts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_opts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_show_opts</span><span class="p">(</span><span class="n">choice_show</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">value</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">ref_opts</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">choice_show</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">input_opts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip_opts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ref_opts</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;choice_show&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;choice_show&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">_show_opts</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;choice_show&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ref_opts</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ref_opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;clmsg_id&#39;</span><span class="p">,</span> <span class="s1">&#39;output_json&#39;</span><span class="p">,</span> <span class="s1">&#39;output_json_append&#39;</span><span class="p">,</span> <span class="s1">&#39;stdout_log&#39;</span><span class="p">,</span> <span class="s1">&#39;capture_stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;capture_maxsize&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">skip_opts</span> <span class="ow">and</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_opts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">choice_show</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;choice_show&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;choice_show&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">conf</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="n">default</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">default</span> <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="o">!=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">default</span>
            <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">else</span> <span class="n">default</span>
            <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">else</span> <span class="n">default</span>
            <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="n">default</span>
            <span class="n">discription_ja</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;discription_ja&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;discription_ja&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">discription_en</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;discription_en&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;discription_en&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">discription_en</span> <span class="k">if</span> <span class="n">language</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Japan&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">language</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ja_JP&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">discription_ja</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;choice&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">]</span> <span class="k">if</span> <span class="n">choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">required</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;required&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">questionary</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">help</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">questionary</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">help</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span><span class="ow">not</span> <span class="n">required</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span><span class="p">()</span>
            <span class="n">_show_opts</span><span class="p">(</span><span class="n">choice_show</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ref_opts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_BOOL</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">==</span><span class="s1">&#39;True&#39;</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_INT</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Options</span><span class="o">.</span><span class="n">T_FLOAT</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">conf</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># 設定ファイルに保存</span>
        <span class="n">common</span><span class="o">.</span><span class="n">saveopt</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">conf_file</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;configure complate.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="Edge.start">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resignin</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edgeを起動します</span>

<span class="sd">        Args:</span>
<span class="sd">            resignin (bool): サインインを再実行する</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, str]: メッセージ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">edge_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.edge&#39;</span>
            <span class="n">common</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">(</span><span class="n">edge_dir</span><span class="p">)</span>
            <span class="n">conf_file</span> <span class="o">=</span> <span class="n">edge_dir</span> <span class="o">/</span> <span class="s1">&#39;edge.conf&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">conf_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command first.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>

            <span class="n">opt</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">loadopt</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;icon_path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;icon_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the icon_path.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;icon_path&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;icon file not found. icon_path=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="s1">&#39;endpoint&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the endpoint.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="s1">&#39;auth_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the auth_type.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;idpw&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the user.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the password.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;apikey&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;apikey&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;apikey&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the apikey.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;oauth2&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;oauth2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;oauth2_port&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2_port.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please set the numeric value in the oauth2_port. oauth2_port=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;azure&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;oauth2_tenant_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_tenant_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2_tenant_id.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;oauth2_client_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_client_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2_client_id.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;oauth2_client_secret&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_client_secret&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2_client_secret.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;oauth2_timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the oauth2_timeout.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please set the numeric value in the oauth2_timeout. oauth2_timeout=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;saml&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;saml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the saml.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;saml_port&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the saml.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please set the numeric value in the saml_port. saml_port=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_port&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;azure&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;saml_tenant_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_tenant_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the saml_tenant_id.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="s1">&#39;saml_timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the saml_timeout.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please set the numeric value in the saml_timeout. saml_timeout=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">msg</span>
                    <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;svcert_no_verify&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svcert_no_verify&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svcert_no_verify&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please run the `edge config` command. And please set the timeout.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Please set the numeric value in the timeout. timeout=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">msg</span>
                <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>

            <span class="c1"># サインイン</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;svcert_no_verify&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">:</span>
                <span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signin</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_type&#39;</span><span class="p">),</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apikey&#39;</span><span class="p">),</span>
                                      <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2_port&#39;</span><span class="p">,</span> <span class="mi">8091</span><span class="p">)),</span>
                                      <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2_tenant_id&#39;</span><span class="p">),</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2_client_id&#39;</span><span class="p">),</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2_client_secret&#39;</span><span class="p">),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth2_timeout&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span>
                                      <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saml&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saml_port&#39;</span><span class="p">,</span> <span class="mi">8091</span><span class="p">)),</span>
                                      <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saml_tenant_id&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saml_timeout&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">msg</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resignin</span><span class="p">:</span>
                <span class="c1"># 常駐開始</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_tray</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Complate.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="Edge.site_request">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.site_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">site_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="n">Any</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">allow_redirects</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ok_status</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ok_status</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Access failed. status_code=</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span></div>


<div class="viewcode-block" id="Edge.exec_pipe">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.exec_pipe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exec_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        パイプを実行します</span>

<span class="sd">        Args:</span>
<span class="sd">            opt (Dict[str, str]): パイプオプション</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, str]: メッセージ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># パイプラインを読み込む</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/gui/load_pipe&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;pipe_cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;pipe_cmd not found. title=</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cmd_title</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pipe_cmd&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cmd_title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">cmd_opt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/gui/load_cmd&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">cmd_title</span><span class="p">))</span>
            <span class="n">cmd_opt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cmd_opt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_opt</span> <span class="ow">or</span> <span class="s1">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_opt</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cmd_opt</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">cmd_opt</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">cmd_opt</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">cmd_opt</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">cmd_title</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">resq</span><span class="o">=</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">())})</span>

        <span class="c1"># パイプラインを実行</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_job</span><span class="p">(</span><span class="n">thevent</span><span class="p">:</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">pipe_cmd</span><span class="p">,</span> <span class="n">prevq</span><span class="p">:</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">):</span>
            <span class="n">resq</span><span class="p">:</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;resq&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;resq&#39;</span><span class="p">]</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">edge_tool</span><span class="o">.</span><span class="n">Tool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">appcls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="p">)</span>
            <span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
            <span class="n">feat</span><span class="p">:</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get_cmd_attr</span><span class="p">(</span><span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">],</span> <span class="s1">&#39;feature&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">thevent</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">prevres</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">prevq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prevq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">prevres</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">resq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">feat</span><span class="o">.</span><span class="n">edgerun</span><span class="p">(</span><span class="n">pipe_cmd</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">prevres</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">thevent</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">resq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                        <span class="n">resq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">resq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_jobs</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pipe_cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
            <span class="n">prevq</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">pipeline</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;resq&#39;</span><span class="p">]</span>
            <span class="n">th</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_job</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pipe_cmd</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threading_event</span><span class="p">,</span> <span class="n">pipe_cmd</span><span class="p">,</span> <span class="n">prevq</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threadings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Pipeline start.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="Edge.stop_jobs">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.stop_jobs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_notify</span><span class="p">:</span><span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;threading_event&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threading_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;threadings&#39;</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">run_found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threadings</span><span class="p">:</span>
                    <span class="n">th</span><span class="p">:</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span> <span class="o">=</span> <span class="n">th</span>
                    <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="n">run_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">run_found</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_notify</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threadings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Jobs stopped.&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Jobs not running.&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">no_notify</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Jobs not running.&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threading_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threadings</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Edge.start_tray">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.start_tray">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_tray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># トレイアイコンを起動</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pystray</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">list_cmd</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/gui/list_cmd&quot;</span><span class="p">)</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">mkcmd</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">_ex</span><span class="p">():</span>
                        <span class="n">tool</span> <span class="o">=</span> <span class="n">edge_tool</span><span class="o">.</span><span class="n">Tool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">appcls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="p">)</span>
                        <span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
                        <span class="n">feat</span><span class="p">:</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get_cmd_attr</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">],</span> <span class="s1">&#39;feature&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">feat</span><span class="o">.</span><span class="n">edgerun</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                            <span class="k">pass</span>
                    <span class="k">return</span> <span class="n">_ex</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">mkcmd</span><span class="p">(</span><span class="n">opt</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">items</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">list_pipe</span><span class="p">():</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="s2">&quot;/gui/list_pipe&quot;</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">mkpipe</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_pipe</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">mkpipe</span><span class="p">(</span><span class="n">opt</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">items</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">list_opens</span><span class="p">():</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s2">&quot;/gui/toolmenu&quot;</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="n">opens</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Gui&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">open_browser</span><span class="p">(</span><span class="s1">&#39;/gui&#39;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">opens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">mkop</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span><span class="n">edge_tool</span><span class="o">.</span><span class="n">Tool</span><span class="p">,</span> <span class="n">href</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">open_browser</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">],</span> <span class="n">mkop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="p">,</span> <span class="n">op</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">items</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">pystray</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span>
                <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="n">pystray</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="o">*</span><span class="n">list_opens</span><span class="p">())),</span>
                <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Commands&#39;</span><span class="p">,</span><span class="n">pystray</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="o">*</span><span class="n">list_cmd</span><span class="p">())),</span>
                <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Pipelines&#39;</span><span class="p">,</span><span class="n">pystray</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="o">*</span><span class="n">list_pipe</span><span class="p">())),</span>
                <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Actions&#39;</span><span class="p">,</span> <span class="n">pystray</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span>
                    <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Retry signin&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span>
                    <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Stop jobs&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_jobs</span><span class="p">(</span><span class="kc">False</span><span class="p">)),)),</span>
                <span class="n">pystray</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Quit&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">icon</span><span class="o">.</span><span class="n">stop</span><span class="p">()),)</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="n">pystray</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="o">.</span><span class="n">__appid__</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ver</span><span class="o">.</span><span class="n">__title__</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Edge start.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">icon</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<div class="viewcode-block" id="Edge.load_user_info">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.load_user_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s2">&quot;/gui/user_info&quot;</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="Edge.signin">
<a class="viewcode-back" href="../../../resources/cmdbox.app.html#cmdbox.app.edge.Edge.signin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">signin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
               <span class="n">oauth2</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">oauth2_port</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">oauth2_tenant_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">oauth2_client_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">oauth2_client_secret</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
               <span class="n">oauth2_timeout</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
               <span class="n">saml</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">saml_port</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">saml_tenant_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
               <span class="n">saml_timeout</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        サインインを行います</span>

<span class="sd">        Args:</span>
<span class="sd">            auth_type (str): 認証タイプ</span>
<span class="sd">            user (str): ユーザー名</span>
<span class="sd">            password (str): パスワード</span>
<span class="sd">            apikey (str): APIキー</span>
<span class="sd">            oauth2 (str): OAuth2</span>
<span class="sd">            oauth2_port (int): OAuth2ポート</span>
<span class="sd">            oauth2_tenant_id (str): OAuth2テナントID</span>
<span class="sd">            oauth2_client_id (str): OAuth2クライアントID</span>
<span class="sd">            oauth2_client_secret (str): OAuth2クライアントシークレット</span>
<span class="sd">            oauth2_timeout (int): OAuth2タイムアウト</span>
<span class="sd">            saml (str): SAML</span>
<span class="sd">            saml_port (int): SAMLポート</span>
<span class="sd">            saml_tenant_id (str): SAMLテナントID</span>
<span class="sd">            saml_timeout (int): SAMLタイムアウト</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int, Dict[str, Any]]: 終了コード, メッセージ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span> <span class="o">=</span> <span class="n">oauth2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saml</span> <span class="o">=</span> <span class="n">saml</span>
        <span class="k">if</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;noauth&quot;</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s2">&quot;/gui&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;No auth.&quot;</span><span class="p">)</span>

        <span class="c1"># ID/PW認証を使用する場合</span>
        <span class="k">elif</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;idpw&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --user option.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --password option.&quot;</span><span class="p">)</span>

            <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="s2">&quot;/dosignin/gui&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">),</span> <span class="n">ok_status</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">307</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin Success.&quot;</span><span class="p">)</span>

        <span class="c1"># APIKEY認証を使用する場合</span>
        <span class="k">elif</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">apikey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --apikey option.&quot;</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s2">&quot;/gui&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;apikey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apikey</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin Success.&quot;</span><span class="p">)</span>

        <span class="c1"># OAuth2認証を使用する場合</span>
        <span class="k">elif</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;oauth2&quot;</span><span class="p">:</span>
            <span class="c1"># Google OAuth2を使用する場合</span>
            <span class="k">if</span> <span class="n">oauth2</span> <span class="o">==</span> <span class="s2">&quot;google&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oauth2_client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_id option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_client_secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_secret option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_timeout option.&quot;</span><span class="p">)</span>
                <span class="n">redirect_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">oauth2_port</span><span class="si">}</span><span class="s1">/oauth2/google/callback&#39;</span>
                <span class="c1"># OAuth2認証のコールバックを受けるFastAPIサーバーを起動</span>
                <span class="n">fastapi</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
                <span class="nd">@fastapi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/oauth2/google/callback&#39;</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">oauth2_google_callback</span><span class="p">(</span><span class="n">req</span><span class="p">:</span><span class="n">Request</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Invalid state.&quot;</span><span class="p">)</span>
                    <span class="c1"># アクセストークン取得</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">}</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                            <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="n">oauth2_client_secret</span><span class="p">,</span>
                            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                            <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">}</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">token_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://oauth2.googleapis.com/token&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                                       <span class="n">verify</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">)</span>
                        <span class="n">token_resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="n">token_json</span> <span class="o">=</span> <span class="n">token_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_json</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
                        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/oauth2/google/session/</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">/gui&quot;</span><span class="p">,</span> <span class="n">ok_status</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">307</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success. Please close your browser.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Failed to get token. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;thUvicorn&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ThreadedUvicorn</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">fastapi</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">oauth2_port</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># OAuth2認証のリクエストを送信</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;access_type&#39;</span><span class="p">:</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;edge&#39;</span><span class="p">}</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://accounts.google.com/o/oauth2/auth?</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># 認証完了まで指定秒数待つ</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tm</span> <span class="o">&gt;</span> <span class="n">oauth2_timeout</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Signin Timeout.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success.&quot;</span><span class="p">)</span>

            <span class="c1"># GitHub OAuth2を使用する場合</span>
            <span class="k">elif</span> <span class="n">oauth2</span> <span class="o">==</span> <span class="s2">&quot;github&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oauth2_client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_id option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_client_secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_secret option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_timeout option.&quot;</span><span class="p">)</span>

                <span class="n">redirect_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">oauth2_port</span><span class="si">}</span><span class="s1">/oauth2/github/callback&#39;</span>
                <span class="c1"># OAuth2認証のコールバックを受けるFastAPIサーバーを起動</span>
                <span class="n">fastapi</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
                <span class="nd">@fastapi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/oauth2/github/callback&#39;</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">oauth2_github_callback</span><span class="p">(</span><span class="n">req</span><span class="p">:</span><span class="n">Request</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Invalid state.&quot;</span><span class="p">)</span>
                    <span class="c1"># アクセストークン取得</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                            <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="n">oauth2_client_secret</span><span class="p">,</span>
                            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">}</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">token_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://github.com/login/oauth/access_token&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                                       <span class="n">verify</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">)</span>
                        <span class="n">token_resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="n">token_json</span> <span class="o">=</span> <span class="n">token_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_json</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
                        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/oauth2/github/session/</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">/gui&quot;</span><span class="p">,</span> <span class="n">ok_status</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">307</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success. Please close your browser.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Failed to get token. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;thUvicorn&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ThreadedUvicorn</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">fastapi</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">oauth2_port</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># OAuth2認証のリクエストを送信</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;access_type&#39;</span><span class="p">:</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;edge&#39;</span><span class="p">}</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://github.com/login/oauth/authorize?</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># 認証完了まで指定秒数待つ</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tm</span> <span class="o">&gt;</span> <span class="n">oauth2_timeout</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Signin Timeout.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success.&quot;</span><span class="p">)</span>

            <span class="c1"># Azure OAuth2を使用する場合</span>
            <span class="k">elif</span> <span class="n">oauth2</span> <span class="o">==</span> <span class="s2">&quot;azure&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oauth2_tenant_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_tenant_id option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_id option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_client_secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_client_secret option.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oauth2_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --oauth2_timeout option.&quot;</span><span class="p">)</span>

                <span class="n">redirect_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">oauth2_port</span><span class="si">}</span><span class="s1">/oauth2/azure/callback&#39;</span>
                <span class="c1"># OAuth2認証のコールバックを受けるFastAPIサーバーを起動</span>
                <span class="n">fastapi</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
                <span class="nd">@fastapi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/oauth2/azure/callback&#39;</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">oauth2_azure_callback</span><span class="p">(</span><span class="n">req</span><span class="p">:</span><span class="n">Request</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Invalid state.&quot;</span><span class="p">)</span>
                    <span class="c1"># アクセストークン取得</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tenant&#39;</span><span class="p">:</span> <span class="n">oauth2_tenant_id</span><span class="p">,</span>
                            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;openid&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">]),</span>
                            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                            <span class="c1">#&#39;client_secret&#39;: oauth2_client_secret,</span>
                            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                            <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">}</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">token_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;https://login.microsoftonline.com/</span><span class="si">{</span><span class="n">oauth2_tenant_id</span><span class="si">}</span><span class="s1">/oauth2/v2.0/token&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                                       <span class="n">verify</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">)</span>
                        <span class="n">token_resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="n">token_json</span> <span class="o">=</span> <span class="n">token_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_json</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
                        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/oauth2/azure/session/</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">/gui&quot;</span><span class="p">,</span> <span class="n">ok_status</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">307</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success. Please close your browser.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Failed to get token. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;thUvicorn&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ThreadedUvicorn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">Config</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">fastapi</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">oauth2_port</span><span class="p">),</span> <span class="p">{})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># OAuth2認証のリクエストを送信</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;openid&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;access_type&#39;</span><span class="p">:</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">oauth2_client_id</span><span class="p">,</span>
                        <span class="s1">&#39;response_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;edge&#39;</span><span class="p">}</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://login.microsoftonline.com/</span><span class="si">{</span><span class="n">oauth2_tenant_id</span><span class="si">}</span><span class="s1">/oauth2/v2.0/authorize?</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># 認証完了まで指定秒数待つ</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tm</span> <span class="o">&gt;</span> <span class="n">oauth2_timeout</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Signin Timeout.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success.&quot;</span><span class="p">)</span>

        <span class="c1"># saml認証を使用する場合</span>
        <span class="k">elif</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;saml&quot;</span><span class="p">:</span>
            <span class="c1"># Azure samlを使用する場合</span>
            <span class="k">if</span> <span class="n">saml</span> <span class="o">==</span> <span class="s2">&quot;azure&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">saml_tenant_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Please specify the --saml_tenant_id option.&quot;</span><span class="p">)</span>
                <span class="n">saml_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span><span class="o">==</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="n">idp</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">entityId</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;https://sts.windows.net/</span><span class="si">{</span><span class="n">saml_tenant_id</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
                        <span class="n">singleSignOnService</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;https://login.microsoftonline.com/</span><span class="si">{</span><span class="n">saml_tenant_id</span><span class="si">}</span><span class="s1">/saml2&#39;</span><span class="p">,</span>
                            <span class="n">binding</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&#39;</span><span class="p">),</span>
                        <span class="n">certFingerprint</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">certFingerprintAlgorithm</span><span class="o">=</span><span class="s1">&#39;sha1&#39;</span><span class="p">,</span>
                        <span class="n">singleLogoutService</span><span class="o">=</span><span class="nb">dict</span><span class="p">()),</span>
                    <span class="n">sp</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">entityId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                        <span class="n">assertionConsumerService</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">saml_port</span><span class="si">}</span><span class="s1">/saml/azure/callback&#39;</span><span class="p">,</span>
                            <span class="n">binding</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&#39;</span><span class="p">),</span>
                        <span class="n">attributeConsumingService</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
                        <span class="n">singleLogoutService</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">binding</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&#39;</span><span class="p">),</span>
                        <span class="n">NameIDFormat</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&#39;</span><span class="p">,</span>
                        <span class="n">x509cert</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">privateKey</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">request_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">https</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
                    <span class="n">http_host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                    <span class="n">server_port</span><span class="o">=</span><span class="n">saml_port</span><span class="p">,</span>
                    <span class="n">script_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/saml/azure/gui?next=gui&#39;</span><span class="p">,</span>
                    <span class="n">post_data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
                    <span class="n">get_data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">random_string</span><span class="p">(</span><span class="mi">8</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">onelogin.saml2.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneLogin_Saml2_Auth</span>
                <span class="n">auth</span> <span class="o">=</span> <span class="n">OneLogin_Saml2_Auth</span><span class="p">(</span><span class="n">request_data</span><span class="o">=</span><span class="n">request_data</span><span class="p">,</span> <span class="n">old_settings</span><span class="o">=</span><span class="n">saml_settings</span><span class="p">)</span>

                <span class="c1"># SAML認証のコールバックを受けるFastAPIサーバーを起動</span>
                <span class="n">fastapi</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
                <span class="nd">@fastapi</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/saml/azure/callback&#39;</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">saml_azure_callback</span><span class="p">(</span><span class="n">req</span><span class="p">:</span><span class="n">Request</span><span class="p">):</span>
                    <span class="n">form_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/saml/azure/callback&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">form_data</span><span class="p">,</span> <span class="n">ok_status</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">307</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Signin failed.&quot;</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_info</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;auth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_type</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;saml_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">str2b64str</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">_dict</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">svcert_no_verify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saml</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success. Please close your browser.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Failed to get token. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;thUvicorn&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ThreadedUvicorn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">Config</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">fastapi</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">saml_port</span><span class="p">),</span> <span class="p">{})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thUvicorn</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># SAML認証のリクエストを送信</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">login</span><span class="p">())</span>

                <span class="c1"># 認証完了まで指定秒数待つ</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_in</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tm</span> <span class="o">&gt;</span> <span class="n">saml_timeout</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;Signin Timeout.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="s2">&quot;Signin success.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="s2">&quot;unsupported auth_type.&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) 2023-2025 hamacom2004jp All Rights Reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>